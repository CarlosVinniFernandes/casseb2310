# Pipeline CI/CD para GitLab
# Atividade 6 - Qualidade de Software

stages:
  - lint
  - test
  - security
  - deploy

# Vari√°veis globais
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHON_VERSION: "3.11"

# Cache para acelerar builds
cache:
  paths:
    - .cache/pip
    - venv/

# Template base para jobs Python
.python_base:
  image: python:${PYTHON_VERSION}
  before_script:
    - python --version
    - pip install --upgrade pip
    - pip install virtualenv
    - virtualenv venv
    - source venv/bin/activate
    - pip install -r requirements-dev.txt

# ============================================
# STAGE 1: LINTING - Qualidade de C√≥digo
# ============================================

flake8:
  extends: .python_base
  stage: lint
  script:
    - echo "üîç Executando Flake8 - Verifica√ß√£o de estilo de c√≥digo..."
    - flake8 . --count --statistics --format=html --htmldir=flake8-report || true
    - flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
    - echo "‚úÖ Flake8 conclu√≠do"
  artifacts:
    when: always
    paths:
      - flake8-report/
    expire_in: 1 week
  allow_failure: false

pylint:
  extends: .python_base
  stage: lint
  script:
    - echo "üîç Executando Pylint - An√°lise est√°tica de c√≥digo..."
    - pylint app.py produto_manager.py --output-format=text || true
    - pylint app.py produto_manager.py --exit-zero
    - echo "‚úÖ Pylint conclu√≠do"
  allow_failure: true

black-check:
  extends: .python_base
  stage: lint
  script:
    - echo "üé® Verificando formata√ß√£o com Black..."
    - black --check --diff app.py produto_manager.py test_*.py
    - echo "‚úÖ Formata√ß√£o verificada"
  allow_failure: true

code-quality:
  extends: .python_base
  stage: lint
  script:
    - echo "üìä An√°lise de qualidade de c√≥digo..."
    - pip install radon
    - echo "--- Complexidade Ciclom√°tica ---"
    - radon cc app.py produto_manager.py -a -s
    - echo "--- √çndice de Manutenibilidade ---"
    - radon mi app.py produto_manager.py -s
    - echo "‚úÖ An√°lise de qualidade conclu√≠da"
  allow_failure: true

# ============================================
# STAGE 2: TESTES - Testes Unit√°rios
# ============================================

unit-tests:
  extends: .python_base
  stage: test
  script:
    - echo "üß™ Executando testes unit√°rios com pytest..."
    - pytest -v --cov=. --cov-report=term-missing --cov-report=html --cov-report=xml
    - echo "‚úÖ Testes conclu√≠dos"
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    when: always
    paths:
      - htmlcov/
      - coverage.xml
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 1 week
  allow_failure: false

integration-tests:
  extends: .python_base
  stage: test
  script:
    - echo "üîó Executando testes de integra√ß√£o..."
    - pytest test_app.py -v -m integration || pytest test_app.py -v
    - echo "‚úÖ Testes de integra√ß√£o conclu√≠dos"
  allow_failure: true

# ============================================
# STAGE 3: SEGURAN√áA - An√°lise de Seguran√ßa
# ============================================

safety-check:
  extends: .python_base
  stage: security
  script:
    - echo "üîí Verificando vulnerabilidades de seguran√ßa..."
    - pip install safety
    - safety check --json || true
    - echo "‚úÖ Verifica√ß√£o de seguran√ßa conclu√≠da"
  allow_failure: true

bandit:
  extends: .python_base
  stage: security
  script:
    - echo "üõ°Ô∏è Executando an√°lise de seguran√ßa com Bandit..."
    - pip install bandit
    - bandit -r app.py produto_manager.py -f json -o bandit-report.json || true
    - bandit -r app.py produto_manager.py
    - echo "‚úÖ An√°lise de seguran√ßa conclu√≠da"
  artifacts:
    when: always
    paths:
      - bandit-report.json
    expire_in: 1 week
  allow_failure: true

# ============================================
# STAGE 4: DEPLOY - Implanta√ß√£o
# ============================================

deploy-staging:
  stage: deploy
  image: python:${PYTHON_VERSION}
  script:
    - echo "üöÄ Preparando deploy para staging..."
    - echo "‚úÖ Deploy staging conclu√≠do (simulado)"
  environment:
    name: staging
    url: https://staging-sistema-produtos.onrender.com
  only:
    - develop
  when: manual
  allow_failure: true

deploy-production:
  stage: deploy
  image: python:${PYTHON_VERSION}
  script:
    - echo "üöÄ Deploy para produ√ß√£o..."
    - echo "‚úÖ Deploy production conclu√≠do"
    - echo "üìã Instru√ß√µes para deploy no Render:"
    - echo "   1. Conecte este reposit√≥rio ao Render"
    - echo "   2. Configure o Web Service"
    - echo "   3. O Render far√° deploy autom√°tico"
  environment:
    name: production
    url: https://sistema-produtos.onrender.com
  only:
    - main
    - master
  when: manual
  allow_failure: true

# ============================================
# JOBS EXTRAS - Utilit√°rios
# ============================================

generate-badge:
  extends: .python_base
  stage: test
  script:
    - echo "üèÖ Gerando badges de qualidade..."
    - pip install anybadge
    - anybadge --label=pipeline --value=passing --file=pipeline-badge.svg passing=green failing=red
    - echo "‚úÖ Badges geradas"
  artifacts:
    paths:
      - pipeline-badge.svg
    expire_in: 1 week
  allow_failure: true
